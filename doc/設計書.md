# 📄 **SQL テーブル定義書**

## 1. **municipalities（自治体テーブル）**

```sql
CREATE TABLE municipalities (
    municipality_id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL UNIQUE
);
```

### 説明:
- **municipality_id**: 自治体ID (主キー)
- **name**: 自治体名 (ユニーク)

---

## 2. **categories（カテゴリマスタテーブル）**

```sql
CREATE TABLE categories (
    category_id SERIAL PRIMARY KEY,
    category_name VARCHAR(255) NOT NULL UNIQUE
);
```

### 説明:
- **category_id**: カテゴリID (主キー)
- **category_name**: カテゴリ名

---

## 3. **item_types（ごみ品目マスタテーブル）**

```sql
CREATE TABLE item_types (
    type_id SERIAL PRIMARY KEY,
    type_name VARCHAR(255) NOT NULL UNIQUE
);
```

### 説明:
- **type_id**: ごみ品目ID (主キー)
- **type_name**: ごみ品目名

---

## 4. **municipality_itemtype_category_map（自治体ごみ品目カテゴリマッピングテーブル）**

```sql
CREATE TABLE municipality_itemtype_category_map (
    municipality_id INTEGER REFERENCES municipalities(municipality_id),
    type_id INTEGER REFERENCES item_types(type_id),
    category_id INTEGER REFERENCES categories(category_id),
    PRIMARY KEY (municipality_id, type_id)
);
```

### 説明:
- **municipality_id**: 自治体ID (外部キー)
- **type_id**: ごみ品目ID (外部キー)
- **category_id**: カテゴリID (外部キー)
- **PRIMARY KEY**: 複合キーで`municipality_id`と`type_id`を組み合わせて一意とする

---

## 5. **municipality_category_instructions（捨て方情報テーブル）**

```sql
CREATE TABLE municipality_category_instructions (
    instruction_id SERIAL PRIMARY KEY,
    municipality_id INTEGER REFERENCES municipalities(municipality_id),
    category_id INTEGER REFERENCES categories(category_id),
    instruction_text TEXT NOT NULL
);
```

### 説明:
- **instruction_id**: 捨て方情報ID (主キー)
- **municipality_id**: 自治体ID (外部キー)
- **category_id**: カテゴリID (外部キー)
- **instruction_text**: 捨て方の詳細な説明

---

# 📄 **Elasticsearch JSON コレクション定義書**

## 1. **物品名コレクション (objects インデックス)**

### インデックス名: `objects`

```json
PUT objects
{
  "mappings": {
    "properties": {
      "object_id": {
        "type": "keyword"
      },
      "type_id": {
        "type": "keyword"
      },
      "object_name": {
        "type": "text",
        "analyzer": "standard"
      },
      "embedding": {
        "type": "dense_vector",
        "dims": 768
      }
    }
  }
}
```

### 説明:
- **object_id**: 物品ID (一意識別用、`keyword`型)
- **type_id**: ごみ品目ID (RDBの`item_types`に紐づくID、`keyword`型)
- **object_name**: 物品名 (自由検索が必要なため`text`型)
- **embedding**: ベクトル表現での類似検索用 (`dense_vector`型、次元数は使用するモデルに合わせる。例: 768次元)

---

## 2. **物品検索時のサンプルデータ投入**

```json
POST objects/_doc/1
{
  "object_id": "1",
  "type_id": "1",
  "object_name": "ティッシュ",
  "embedding": [0.12, 0.34, 0.56, ..., 0.78]
}

POST objects/_doc/2
{
  "object_id": "2",
  "type_id": "1",
  "object_name": "トイレットペーパー",
  "embedding": [0.23, 0.45, 0.67, ..., 0.89]
}
```

---

# 📝 **データベースとElasticsearchの連携ポイント**

1. **RDBに登録されるデータ**:
   - 自治体 (`municipalities`)  
   - カテゴリ (`categories`)  
   - ごみ品目 (`item_types`)  
   - マッピング (`municipality_itemtype_category_map`)  
   - 捨て方情報 (`municipality_category_instructions`)

2. **Elasticsearchに登録されるデータ**:
   - 物品名 (`objects`)  
   - Embedding（ベクトル）による類似検索用のデータ

3. **検索の流れ**:
   1. ユーザーが物品名を検索すると、Elasticsearchで`object_name`または`embedding`を使って類似する物品を検索。  
   2. Elasticsearchが返した`type_id`をもとに、RDBで該当の自治体・カテゴリ情報・捨て方情報を取得。  
   3. 結果を統合してユーザーに返す。

